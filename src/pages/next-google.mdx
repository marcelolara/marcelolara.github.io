# Desplegar sitio web nextjs en google cloud platform

## Crear projecto nextjs

1. Crear un nuevo proyecto siguiendo la documentacion oficial de
[nextjs](https://nextjs.org/docs/getting-started/installation).


## Dockerizar el proyecto
Para dockerizar el proyecto se debe crear un archivo llamado `Dockerfile` en la raiz del proyecto
el cual contendrá multiples escenarios para haer los despliegues más rápidos.
y eficientes.

```dockerfile
FROM node:18-alpine
WORKDIR /app
COPY package*.json ./
RUN npm install
COPY . .
EXPOSE 3000
CMD npm run dev
```

## Docker Compose
Luego agregamos el archivo `docker-compose.yml` para hacer más simple el proceso
de construir el contenedor y ejecutarlo.

```yml
version: '3.8'
services:
  app:
    build:
      context: ./
      dockerfile: Dockerfile
    volumes:
      - .:/app
      - /app/node_modules
      - /app/.next
    ports:
      - "3000:3000"
```

Ahora podemos inciar el proyecto de forma local con el comando.

```bash 
docker-compose up
```

## Desplegar en google cloud platform

Creamos el archivo `app.json` en la raiz del proyecto con el siguiente 
contenido.

```json
{
  "name": "nextjs",
  "options": {
    "allow-unauthenticated": true,
    "memory": "256Mi",
    "cpu": "1",
    "port": 3000,
    "http2": false
  }
}
```

Por defecto, Cloud Run espera que las aplicaciones se ejecuten en el puerto 8080, 
por lo que este archivo app.json le indica a Cloud Run que escuche en el puerto 
3000 en lugar del predeterminado.

Adicionalmente, también le indica a Cloud Run que abra la aplicación para que
sea de acceso público con `allow-unauthenticated` establecido en `true`. Luego
se le indica que use 1 CPU y 256MB de memoria para cada contenedor.
Finalmente, le indica a Cloud Run que no use HTTP2 para este servicio.


### Probando el despliegue a google cloud platform

Para este caso usaremos el cli de google cloud platform, para instalarlo
se puede seguir la documentación oficial de 
[google cloud platform](https://cloud.google.com/sdk/docs/install) según el
sistema operativo que se esté usando.

Luego de instalar el cli, se debe iniciar sesión con el siguiente comando.

```bash
gcloud auth login
```

En este punto es posible obtener los proyectos ya creados en GCP de la siguiente
forma.

```bash
gcloud projects list
```

En caso de no tener ninguno, o quere crear uno nuevo, se puede hacer con el
siguiente comando.

```bash
gcloud projects create <PROJECT_ID>
```

Una vez resuelto el problema del proyecto a elegir, este se puede configur
con el siguiente comando.

```bash
gcloud config set project <PROJECT_ID>
```

Ahora podemos desplegar el proyecto con el siguiente comando, al ser un comando
sin argumentos, se abrirá una interfaz para configurar el despliegue. 

```bash
gcloud run deploy
```

En caso de querer hacerlo de forma más rápida se puede revisar la documentación
oficial de [google cloud platform](https://cloud.google.com/sdk/gcloud/reference/run/deploy).
en la que se puede configurar el despligue con los argumentos deseados.






## Subiendo el proyecto a github
Para subir el proyecto a github, primero debemos crear un repositorio en github
y luego subir el proyecto con los siguientes comandos.

```bash
gh repo create (Seguir los pasos que indica la consola)
```

```bash
? What would you like to do? **Push an existing local repository to GitHub**
? Path to local repository **.**
? Repository name **nextjs-docker-githubaction-google-cloud**
? Repository owner **<YOUR_USER>**
? Description 
? Visibility **Public / private**
✓ Created repository <YOUR_USER>/nextjs-docker-githubaction-google-cloud on GitHub
? Add a remote? **Yes**
? What should the new remote be called? **origin**
✓ Added remote git@github.com:<YOUR_USER>/nextjs-docker-githubaction-google-cloud.git
? Would you like to push commits from the current branch to "origin"? Yes
...
✓ Pushed commits to git@github.com:<YOUR_USER>/nextjs-docker-githubaction-google-cloud.git
```




## Desplegar en google cloud platform con github actions